<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ERP Upload Builder (2√ó CSV Uploads)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0f1115;--panel:#171923;--muted:#8b8fa6;--text:#eef0ff;--accent:#7c9cff;--accent2:#4ade80;--danger:#f87171;--border:#24283a}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
  header{padding:24px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#111321,#0f1115)} h1{margin:0;font-size:20px}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  label{display:block;margin:0 0 8px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em;font-size:12px}
  input[type=file], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b0d13;color:var(--text)}
  .hint{color:var(--muted);font-size:12px;margin-top:6px} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{background:var(--accent);border:none;color:#0b0d13;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  button.secondary{background:#252a3f;color:var(--text)}
  .ok{color:var(--accent2)} .err{color:var(--danger)} .pill{display:inline-block;background:#1d2133;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;font-size:12px} th,td{border-bottom:1px solid var(--border);padding:8px;vertical-align:top} th{text-align:left;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  details{background:#101424;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--muted)}
</style>
</head>
<body>
<header class="wrap">
  <h1>üß© ERP Upload Builder ‚Äî strict <span class="pill">NAME ‚Üî STYLE CODE</span></h1>
  <div class="hint">Upload <b>names_and_descriptions.csv</b> and <b>range_tracker.csv</b> (CSV UTF-8). Click Generate to download <b>erp_upload.csv</b>.</div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <label>1) Upload Names & Descriptions (CSV/TSV)</label>
      <input id="namesFile" type="file" accept=".csv,.tsv,.txt" />
      <div class="hint">Required columns (case-insensitive): <span class="mono">NAME, SKU, SIZE, HS Code, EAN</span>. Optional: <span class="mono">COO, RRP, DESCRIPTION</span></div>
      <div class="hint">Join key: <b>NAME</b> (left) ‚Üí <b>STYLE CODE</b> (right)</div>
      <div id="namesStatus" class="hint"></div>
    </div>
    <div class="card">
      <label>2) Upload Range Tracker (CSV/TSV)</label>
      <input id="trackerFile" type="file" accept=".csv,.tsv,.txt" />
      <div class="hint">Required columns: <span class="mono">STYLE CODE, Line Description, COO, Sell Price</span></div>
      <div id="trackerStatus" class="hint"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="row">
      <button id="genBtn">üöÄ Generate ERP CSV</button>
      <a id="dlLink" download="erp_upload.csv" class="pill" style="display:none">‚¨áÔ∏è Download erp_upload.csv</a>
      <span id="log" class="hint"></span>
    </div>
    <details style="margin-top:10px">
      <summary>Match diagnostics</summary>
      <div id="diag" class="hint" style="margin-top:8px"></div>
    </details>
  </div>

  <div class="card" id="previewCard" style="display:none">
    <label>Preview (first 20 rows)</label>
    <div style="overflow:auto"><table id="previewTable"></table></div>
  </div>

  <div class="hint" style="margin-top:10px">
    Logic: strict <b>INNER JOIN</b> on <span class="mono">NAME (names CSV)</span> = <span class="mono">STYLE CODE (tracker CSV)</span>. Rows without <b>SKU</b> are ignored.
  </div>
</div>

<script>
/* ---------- utils ---------- */
const byId = id => document.getElementById(id);
const clean = s => (s??"").toString().replace(/\u00A0/g,' ').normalize("NFKC").trim();
const cleanKey = s => clean(s).replace(/[‚Äê‚Äì‚Äî‚àí]/g,'-').replace(/\s+/g,' ').toUpperCase();

/* detect delimiter & parse CSV/TSV (quote-aware enough for commas/tabs) */
function parseTable(text){
  text = text.trim(); if(!text) return [];
  let delim = '\t';
  const count = ch => (text.match(new RegExp(ch,'g'))||[]).length;
  const comma=count(','), tab=count('\t'), semi=count(';');
  if (comma>tab && comma>semi) delim=','; else if (semi>tab && semi>comma) delim=';';
  const rows=[]; let i=0, field='', row=[], inQ=false, c, prev=null;
  while(i<text.length){
    c=text[i++]; if(c=='"'){ if(inQ && text[i]=='"'){field+='"'; i++;} else inQ=!inQ; }
    else if(c===delim && !inQ){ row.push(field); field=''; }
    else if((c=='\n'||c=='\r') && !inQ){ if(prev=='\r' && c=='\n'){prev=c; continue;} row.push(field); field=''; rows.push(row); row=[]; }
    else { field+=c; } prev=c;
  }
  if(field.length||row.length){row.push(field); rows.push(row);}
  const header=(rows.shift()||[]).map(h=>clean(h));
  return rows.filter(r=>r.some(x=>clean(x)!=='')).map(r=>{
    const o={}; header.forEach((h,i)=>o[h]=clean(r[i]??'')); return o;
  });
}
function readFileAsText(file){
  return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(fr.error); fr.onload=()=>res(fr.result); fr.readAsText(file); });
}
function toCSV(rows){
  if(!rows.length) return '';
  const headers=Object.keys(rows[0]);
  const esc=v=>{const s=(v==null?'':String(v)); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;};
  const lines=[headers.map(esc).join(',')]; for(const r of rows) lines.push(headers.map(h=>esc(r[h])).join(','));
  return '\uFEFF'+lines.join('\n'); // BOM for Excel
}
function categoryFrom(text){
  const t=(text||'').toLowerCase();
  if (/(bag|tote|purse)/.test(t)) return "SistersandSeekers : Accessories : Accessories : Bags";
  if (/(blazer|jacket|cardi|coat|mac)/.test(t)) return "SistersandSeekers : Clothing : Outerwear : Blazers";
  if (/(trouser|pant|legging|jean)/.test(t)) return "SistersandSeekers : Clothing : Bottoms : Trousers";
  if (/(jumper|sweater|knit|hoodie)/.test(t)) return "SistersandSeekers : Clothing : Knitwear : Tops";
  if (/(top|tee|shirt|polo|longsleeve)/.test(t)) return "SistersandSeekers : Clothing : Tops : Tees";
  if (/(sock|tight|hosiery)/.test(t)) return "SistersandSeekers : Accessories : Accessories : Hosiery";
  return "SistersandSeekers : Clothing : General";
}
function eanAsStr(s){
  s=clean(s); if(!s) return "";
  if(/^\d+\.0$/.test(s)) return s.slice(0,-2);
  // avoid scientific: let it pass as plain string
  return s;
}
/* header mapping helper */
function mapHeader(rows, candidates){
  if(!rows.length) return null;
  const headers=Object.keys(rows[0]); const norm=s=>s.toLowerCase().replace(/[^a-z0-9]/g,'');
  const lut={}; headers.forEach(h=>lut[norm(h)]=h);
  for(const cand of candidates){
    const k=norm(cand);
    if(lut[k]) return lut[k];
    for(const h of headers){ if(norm(h).includes(k)) return h; }
  }
  return null;
}

/* ---------- state ---------- */
let namesRows=[], trackerRows=[];

byId('namesFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; namesRows=[]; byId('dlLink').style.display='none'; byId('previewCard').style.display='none';
  if(!f){ byId('namesStatus').textContent=''; return; }
  try{ const txt=await readFileAsText(f); namesRows=parseTable(txt);
       byId('namesStatus').innerHTML=`Loaded <span class="ok">${namesRows.length}</span> rows`; }
  catch(err){ byId('namesStatus').innerHTML=`<span class="err">Failed to read file: ${err}</span>`; }
});
byId('trackerFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; trackerRows=[]; byId('dlLink').style.display='none'; byId('previewCard').style.display='none';
  if(!f){ byId('trackerStatus').textContent=''; return; }
  try{ const txt=await readFileAsText(f); trackerRows=parseTable(txt);
       byId('trackerStatus').innerHTML=`Loaded <span class="ok">${trackerRows.length}</span> rows`; }
  catch(err){ byId('trackerStatus').innerHTML=`<span class="err">Failed to read file: ${err}</span>`; }
});

/* ---------- main generate ---------- */
byId('genBtn').addEventListener('click', ()=>{
  byId('dlLink').style.display='none'; byId('previewCard').style.display='none'; byId('diag').innerHTML=''; byId('log').textContent='';
  if(!namesRows.length){ byId('log').innerHTML='<span class="err">Upload the Names CSV first.</span>'; return; }
  if(!trackerRows.length){ byId('log').innerHTML='<span class="err">Upload the Range Tracker CSV first.</span>'; return; }

  // map headers
  const NAME = mapHeader(namesRows, ["NAME"]);
  const SKU  = mapHeader(namesRows, ["SKU"]);
  const SIZE = mapHeader(namesRows, ["SIZE"]);
  const HS   = mapHeader(namesRows, ["HS Code","HSCode"]);
  const EAN  = mapHeader(namesRows, ["EAN","UPC"]);
  const COO1 = mapHeader(namesRows, ["COO"]);
  const RRP1 = mapHeader(namesRows, ["RRP","Sell Price","Retail"]);
  const DESC1= mapHeader(namesRows, ["DESCRIPTION","DETAILS"]);

  const STYLE2 = mapHeader(trackerRows, ["STYLE CODE","STYLE"]);
  const DESC2  = mapHeader(trackerRows, ["Line Description","Description","Name"]);
  const COO2   = mapHeader(trackerRows, ["COO","Country of Origin"]);
  const PRICE2 = mapHeader(trackerRows, ["Sell Price","RRP","Retail","Retail Price","Price"]);

  if(!NAME || !SKU){ byId('log').innerHTML=`<span class="err">Missing NAME or SKU in Names CSV.</span>`; return; }
  if(!STYLE2){ byId('log').innerHTML=`<span class="err">Missing STYLE CODE in Tracker CSV.</span>`; return; }

  // build index for tracker by STYLE CODE (cleaned)
  const tIndex=new Map(), rightKeys=new Set();
  for(const r of trackerRows){
    const key=cleanKey(r[STYLE2]); if(!key) continue;
    tIndex.set(key,r); rightKeys.add(key);
  }

  // compute left keys, diagnostics
  const leftKeys=new Set(), leftNoSku=new Set();
  for(const r of namesRows){
    const sku=clean(r[SKU]); const key=cleanKey(r[NAME]);
    if(key) leftKeys.add(key); if(!sku) leftNoSku.add(key);
  }
  const leftOnly=[...leftKeys].filter(k=>!rightKeys.has(k));
  const rightOnly=[...rightKeys].filter(k=>!leftKeys.has(k));

  byId('diag').innerHTML =
    `Left keys (unique): ${leftKeys.size} ¬∑ Right keys (unique): ${rightKeys.size}<br>`+
    `Left-only (no tracker match): ${leftOnly.length} ${leftOnly.length? 'e.g. '+leftOnly.slice(0,5).join(', ') : ''}<br>`+
    `Right-only (not in names): ${rightOnly.length} ${rightOnly.length? 'e.g. '+rightOnly.slice(0,5).join(', ') : ''}`;

  // strict inner join + skip rows without SKU
  const out=[]; let kept=0, skipped=0, missing=0;
  for(const r of namesRows){
    const sku=clean(r[SKU]); if(!sku){ skipped++; continue; }
    const key=cleanKey(r[NAME]); if(!key){ skipped++; continue; }
    const t=tIndex.get(key); if(!t){ missing++; continue; }

    const size=clean(r[SIZE]);
    const ean=eanAsStr(r[EAN]);
    const hs=clean(r[HS]);
    const coo=clean(t[COO2] || r[COO1]);
    const price=clean(t[PRICE2] || r[RRP1]);
    const baseName=clean(r[NAME]);
    const descTxt=clean(t[DESC2] || r[DESC1] || baseName);
    const partDesc = (size && size.toUpperCase()!=='ONE SIZE') ? `${descTxt} ${size}` : (descTxt || baseName);
    const category = categoryFrom(descTxt || baseName);
    const parentMatrix = size ? sku.replace(/\d+$/,'').replace(/[ _-]$/,'') : "";

    out.push({
      "externalid": sku,
      "PartNumber": sku,
      "PartDescription": partDesc,
      "DisplayName": baseName,
      "Merchandise Hierarchy": category,
      "HSCode": hs,
      "CountryOfManufacture": coo,
      "UPC": ean,
      "unit type": "Each",
      "stock unit - pair/pack/": "",
      "purchase unit pair/pack": "",
      "Sales unit pair/pack": "",
      "subsid": "Sisters & Seekers Limited",
      "Class": "Product",
      "Department": "SSUK Warehouse : SSUK - Ecomm",
      "Location": "",
      "children true/false": "",
      "salesDescription": partDesc,
      "Sale Price": price,
      "Item - Pricing 1 : Currency (Req)": "GBP",
      "Item - Pricing 1 : Price Level (Req)": "RRP",
      "Item - Pricing 1 : Quantity (Req)": "",
      "costing method": "FIFO",
      "Cost": "",
      "Drop Ship": "",
      "spec order true/false": "",
      "OrderUp toLevel": "",
      "re-order multi": "",
      "reordeer": "",
      "Vendor": "",
      "Prefered Vendor": "",
      "Purchase price": "",
      "cogsaccount": "50000 Cost of Goods Sold",
      "incomeaccount": "40001 Sales : Shopify Sales",
      "assetaccount": "12030 Inventory : Finished Goods",
      "purchasetaxcocde": "",
      "Matrix Type": size ? "Child Matrix Item" : "Standalone Item",
      "Parent Matrix item": parentMatrix,
      "Matrix - Colour": "",
      "Matrix Size": size
    });
    kept++;
  }

  byId('log').innerHTML = `Matched: <span class="ok">${kept}</span> ¬∑ Skipped (no SKU/NAME): ${skipped} ¬∑ No tracker match: ${missing}`;

  if(!out.length){ byId('dlLink').style.display='none'; byId('previewCard').style.display='none'; return; }

  // preview
  const preview=out.slice(0,20), tbl=byId('previewTable');
  tbl.innerHTML=''; const headers=Object.keys(preview[0]);
  const thead=document.createElement('thead'), trh=document.createElement('tr');
  headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); tbl.appendChild(thead);
  const tb=document.createElement('tbody');
  preview.forEach(r=>{ const tr=document.createElement('tr');
    headers.forEach(h=>{ const td=document.createElement('td'); td.textContent=r[h]??""; tr.appendChild(td); });
    tb.appendChild(tr);
  });
  tbl.appendChild(tb); byId('previewCard').style.display='block';

  // download
  const csv=toCSV(out), blob=new Blob([csv],{type:"text/csv;charset=utf-8"}), url=URL.createObjectURL(blob);
  const dl=byId('dlLink'); dl.href=url; dl.style.display='inline-block';
});
</script>
</body>
</html>

